---
title: WebGL系列教程--可视范围
comments: true
toc: true
date: 2017-07-11 21:09:11
tags:
    - 'javascript'
    - 'webgl'
---

### 可视范围基础

#### 盒状空间

* 长方体可是空间，也叫盒状空间，是由正射投影产生。
* 可视锥体空间，由透视投影产生。

在透视投影下，产生的三维场景看上去更是有深度感，更加自然，因为我们平时观察真实世界用的也是透视投影。在大多数情况下，比如三维射击类游戏中，我们都应该采用透视投影。相比之下，正射投影的好处是用户可以方便的比较场景中物体的大小，这是因为物体看上去的大小与其所在的位置没有关系。在建筑平面图等技术绘图的相关场合，应当使用这种投影。

<!-- more -->

#### 盒状空间的工作原理

盒状可视空间的由前后两个矩形表面确定，分别称近裁剪面和远裁剪面，前者的四个顶点为（right,top,-near）,(-left,top,-near),(-left,-bottom,-near),(right,-bottom,-near),而后者的四个顶点为(right,top,far),(-left,top,far),(-left,-bottom,far),(right,-bottom,far).

<img width="300" src="webgl-2017-07-11/1.jpeg"/>

<canvas>上显示的就是可视空间中物体在近裁剪面上的投。如果裁剪面的高宽比和<canvas>不一样，那么画面就会被按照<canvas>的高宽比进行压缩，物体会被扭曲。近裁剪面与远裁剪面之间的盒形空间就是可是空间，只有在此空间内的物体会被显示出来。如果某个物体一部分在可视空间内，一部分在其外，那就只显示可视空间内的部分。

### 正射投影矩阵

#### 函数

* setOrtho(left , right , bottom , top , near , far)
* left / right / bottom / top 参数含义：定位范围。
* near  参数含义：近裁切面。
* far  参数含义：远裁切面。

基本方程式如下：

<img width="300" src="webgl-2017-07-11/2.jpeg"/>

写一个正射投影实例代码，核心代码如下：

编写顶点着色器和片元着色器代码，定义一个uniform矩阵变量。
{% codeblock lang:javascript %}
var vertexShaderSource = `
    attribute vec4 pos;
    uniform mat4 u_mx;
    attribute vec4 a_Color;
    varying vec4 v_Color;

    void main(){
        gl_Position = u_mx * pos;
        v_Color = a_Color;
    }
`

var fragmentShaderSource = `
    precision lowp float;
    varying vec4 v_Color;
    void main(){
        gl_FragColor = v_Color;
    }
`  
{% endcodeblock %}

定义一个正射矩阵的方法
{% codeblock lang:javascript %}
function getOMX(left,right,bottom,top,near,far){

    return new Float32Array([
        2 / (right - left), 0, 0, 0,
        0, 2 / (top - bottom), 0, 0,
        0, 0, -2 / (far - near), 0,
        -(right + left) / (right - left),
        -(top + bottom) / (top - bottom),
        -(far + near) / (far - near),
        1
    ]);

}
var near = 0.0;
var far = .5;

var omx = getOMX(-.5,.5, -.5,.5, near , far);    
{% endcodeblock %}


定义数据data类型化数组
{% codeblock lang:javascript %}
var data = new Float32Array([
    0.0, 0.6, -.4, 0.4, 1.0, 0.4,
    -.45, -.4, -.51, .4, 1.0, .4,
    0.5, -.4, -.4, 1.0, .4, .4,

    .5, .4, -.2, 1.0, .4, .4,
    -.5, .4, -.2, 1.0, 1.0, .3,
    .0, -.6, -.2, 1.0, 1.0, .4
]);   
{% endcodeblock %}

由于定义的far为.5,而data类型化数组数据一个三角形的坐标为-.51，实际效果会产生一个缺角，可以根据改变三角形的顶点来看不同的效果，最终效果如下图：

<img width="300" src="webgl-2017-07-11/3.jpeg"/>

### 缺角的修补

* 将远裁面移到距离视点更远的地方。
* <正射投影矩阵> * <视图矩阵> * <顶点坐标>

代码效果如下：

<img width="300" src="webgl-2017-07-11/4.jpeg"/>

源码链接请访问 https://github.com/wqzwh/webgl-code/tree/master/11